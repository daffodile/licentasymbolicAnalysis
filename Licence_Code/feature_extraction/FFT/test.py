import numpy as np
import matplotlib.pyplot as plt
import scipy
from numpy.fft import fft, fftfreq
from scipy import signal
from scipy.signal import detrend

array = [2.647376, 2.566671, 1.1444675, -1.4162422, -1.7165717, -1.6607049, -2.6646593, -2.8564565, -2.3600903,
         -1.9280795, -1.1063125, -0.384771, 0.3138018, 1.4270537, 0.72352827, -0.6276245, -1.815975, -1.9144425,
         -0.12045812, -0.20415777, -1.2813884, 1.0143603, 1.1772937, -1.2703012, -0.67026407, 0.41032332, -0.68433917,
         -2.120352, -2.7216933, -3.2079282, -3.6956978, -5.0917487, -4.9819183, -1.1661307, 1.9417573, 0.14972118,
         -0.122829, 2.6745105, 3.268737, 1.0244566, -0.40290833, -1.2173378, -2.726364, -3.3094385, -3.3187485,
         -3.634659, -4.1891403, -4.51058, -4.84665, -4.259819, -4.1334863, -4.5312867, -5.235559, -6.5035086, -6.062063,
         -5.6454105, -5.635332, -4.0885143, -4.366185, -6.6145716, -7.493168, -7.4496493, -8.186761, -9.196275,
         -7.810684, -6.948648, -6.0227084, -5.7734904, -7.9144115, -8.911711, -8.969911, -8.313506, -7.084491,
         -7.0699615, -6.944145, -5.0525274, -3.4477448, -3.9682474, -7.051853, -6.771115, -3.826453, -3.2190778,
         -2.970205, -3.248765, -3.438312, -3.3598, -4.678191, -5.1923103, -4.3970695, -5.5555468, -6.795511, -6.1580105,
         -4.412649, -4.109216, -4.1738796, -3.1387904, -3.384501, -3.668143, -3.4952412, -5.3332734, -6.7920723,
         -6.688381, -6.9318023, -7.118139, -8.0619335, -8.804179, -9.916138, -11.315856, -10.659792, -9.074727,
         -9.854838, -11.5038, -10.753011, -8.458666, -8.2352705, -8.918128, -8.632852, -7.645971, -6.85901, -7.8933997,
         -8.638916, -6.364813, -5.596335, -8.808931, -10.167957, -10.922712, -12.548846, -12.380684, -11.495303,
         -11.10288, -9.696347, -6.327509, -4.3708677, -4.7983027, -5.416943, -4.8914104, -2.72093, -1.077858,
         -0.81990004, 0.35194138, -0.119490504, -2.584718, -4.4309664, -5.2995043, -5.0254016, -5.0453715, -5.1425323,
         -5.4761, -3.8626678, -2.6224937, -4.116613, -5.360584, -4.785251, -4.9531755, -6.423896, -8.003752, -9.953356,
         -9.136628, -6.828313, -5.3436613, -5.8392835, -6.6501727, -6.7530837, -8.103605, -10.602035, -12.643284,
         -14.764319, -14.152756, -11.188733, -10.743046, -9.501755, -7.3397303, -7.4591284, -6.178996, -4.3268075,
         -5.6846766, -5.0681896, -1.8591622, -1.7287782, -3.1968832, -4.1930394, -4.989875, -4.3854103, -4.1776767,
         -5.0138893, -5.608758, -7.521254, -10.732282, -11.552062, -8.258639, -5.8173404, -7.2614236, -8.504793,
         -7.4693933, -6.455814, -6.27585, -5.6231003, -4.007463, -4.100839, -4.382362, -4.7528186, -6.580097,
         -6.4427557, -6.0044494, -6.374256, -6.1540623, -6.2685566, -8.256474, -10.059809, -8.82232, -7.199748,
         -6.907723, -5.810408, -4.8354154, -3.4450197, -3.2088106, -3.8566234, -2.4737651, -2.49254, -4.683638,
         -4.011157, -3.084051, -3.7077956, -4.857615, -7.9997654, -8.577944, -6.6778975, -6.4219284, -7.081362,
         -7.866574, -9.4676285, -9.0134115, -7.8088613, -6.8987164, -5.6451716, -3.5011003, -2.0926096, -1.8276501,
         -0.82014054, 1.1391618, 1.3888421, 0.3955247, 0.25601047, -0.61451876, -1.5597475, -0.31663, -0.40363705,
         -2.225098, -4.287239, -4.783634, -4.5885196, -5.2671857, -4.9137416, -4.372107, -3.7085412, -2.2670605,
         -1.8096322, -0.96532303, 1.5025316, 0.35987157, -0.9856398, -0.21274057, -0.7514688, -0.82447267, -0.20464,
         -1.4822899, -2.505462, -1.6470193, -1.2610031, -2.4966364, -3.011851, -1.4234023, -0.2746865, 0.0616554,
         -0.048009887, -0.4279756, -0.89042294, -1.3136277, -0.4610354, -0.6007387, -2.858254, -2.0627937, 2.8974016,
         3.2944698, -0.369165, -2.176079, -0.55820686, 0.72135615, -1.7690762, -4.751047, -3.3215857, -0.7792662,
         -1.6282731, -4.648483, -6.3449802, -2.9677649, -0.8626295, -2.4631374, -4.0855618, -3.8177388, -3.3408823,
         -3.9887683, -3.8089466, -3.7859325, -5.7394238, -6.892024, -7.1832137, -7.720629, -7.704946, -6.3100533,
         -4.684119, -5.7619176, -4.479649, -2.3378994, -0.2086359, 2.6814966, 2.6768897, 1.6786585, 3.1967342,
         2.8650055, 0.28955168, 2.1087103, 4.671828, 4.822246, 2.8947225, 0.69800335, -1.6153245, -2.0912795,
         -0.069800526, 1.1700293, 1.1794071, 3.384348, 3.7049289, 1.2025121, 1.8114711, 4.953229, 7.0263653, 8.186635,
         7.7257934, 8.184889, 6.3428283, 3.9447348, 4.785112, 5.5861344, 3.235018, 0.5042022, 0.78482413, 2.413764,
         1.2164797, -0.7979701, 0.5249578, 1.7945005, 0.74258655, 0.7710833, 2.942692, 5.414229, 6.1530995, 6.067238,
         6.253517, 6.1729074, 5.369924, 3.6900997, 3.2888293, 3.7730408, 4.5509615, 4.6179147, 1.5939257, -1.5112541,
         -0.69328904, -0.9257232, -0.71900845, 2.285199, 3.9093316, 3.3050919, 4.077859, 5.6611905, 4.60185, 4.243617,
         7.9411907, 10.140134, 9.297475, 8.40376, 6.6737456, 5.91745, 6.347653, 6.0111423, 5.461288, 3.831077,
         1.9077668, 2.3944647, 3.8647525, 4.387783, 4.4000816, 4.1066885, 3.9332442, 6.0421944, 7.613289, 7.949214,
         8.005138, 6.714804, 4.7215466, 4.883655, 7.0762553, 6.9044495, 4.7772684, 3.4931617, 1.506488, 0.6071366,
         1.0403354, 2.4551682, 4.141989, 3.9021528, 2.6277673, 2.8708346, 3.967018, 4.180436, 6.795813, 10.817443,
         12.245888, 10.511835, 9.618417, 10.766132, 9.998639, 7.2175336, 4.9301414, 3.294574, 2.9821353, 2.9160392,
         3.4638298, 4.28528, 4.7451487, 7.5615664, 9.671091, 8.711724, 7.3282003, 5.8832364, 6.3009586, 8.900246,
         10.320839, 9.571394, 8.368785, 7.681118, 7.2008333, 5.533394, 3.443693, 3.5806203, 3.3524768, 4.11341,
         6.244225, 6.369267, 5.887859, 7.3900275, 6.6679096, 4.5836706, 2.8472369, 2.7621324, 5.93327, 8.793019,
         7.705485, 4.5940657, 4.156813, 6.4098682, 7.8793006, 6.053878, 2.5232835, 1.3513986, 0.98638034, 0.351523,
         0.26128358, 0.98841673, 1.6047074, 1.2836151, 2.0050514, 2.6270494, 0.65016663, -0.5140825, 0.691144,
         3.8018644, 4.3578043, 2.8460069, 1.6445212, 1.2826533, -0.04066705, -0.9615611, -0.16854331, -0.41535413,
         -1.7348536, -3.270426, -3.5284424, -2.179411, -2.5924363, -1.8457239, -0.2269556, 0.045531385, 0.5427725,
         1.9936496, 1.7395488, 2.5381415, 4.7959213, 4.614434, 3.6078691, 4.399171, 3.556936, 0.2310107, -0.63812745,
         -0.6036751, -1.7921536, -1.4270175, 1.062708, 1.0932225, -1.0673941, 0.23934337, 4.363578, 7.378979, 6.4137783,
         4.6976385, 6.057408, 7.062961, 6.456692, 5.999958, 2.8355415, 0.2016928, 0.4771047, 0.8441457, 0.20727466,
         -1.6802104, -2.8212767, -2.0069752, -2.6439657, -4.611422, -3.9325225, -1.7684879, -0.009333477, -0.5419166,
         -1.6733785, -1.5488316, -0.006979993, 1.6176726, 2.8069909, 2.7374926, 0.5510814, -0.8631092, -0.3312833,
         -0.17876129, 0.2491504, 1.6811752, -0.753017, -3.4154508, -3.3363464, -2.6836224, -2.034011, -2.6746817,
         -3.6117852, -0.38652438, 2.9029884, 2.3210974, 2.5977988, 4.8871717, 6.566373, 5.316606, 3.708918, 4.817977,
         5.156635, 3.3778284, 1.4917885, 0.42717597, -1.2036635, -0.7645099, 0.13805999, -0.23194477, 1.766908,
         2.9222581, 2.115508, -0.04375906, -2.409544, -1.9146446, 0.7369839, 3.6261446, 3.1163983, 2.1143851, 2.2701268,
         3.6668825, 4.6356792, 3.633222, 0.84741896, -0.36040246, 0.10742894, 0.19746672, -3.249806, -5.9118257,
         -3.38933, -0.11448599, 0.24715303, -0.7396929, -1.5200325, 0.4493538, 2.061297, 1.4627458, 0.73296404,
         -0.1873913, -0.08793896, 1.0768374, -0.88439494, -4.3235283, -5.2114363, -4.734551, -6.021304, -7.136086,
         -7.4667916, -7.7271094, -7.271111, -6.5662136, -5.7002683, -5.1557055, -4.2596116, -3.6255682, -2.6275277,
         -2.2632623, -1.0116978, -1.1251013, -2.9413059, -3.1558254, -1.2613534, -0.72587126, -1.9759692, -1.740095,
         -2.8448048, -4.406112, -2.989532, -0.08354522, 0.6317752, -0.9304229, -1.8183974, 1.3737794, 4.149856,
         2.7153013, 1.9019322, 4.0045233, 4.2078624, 3.028692, 3.5719917, 4.064571, 2.5505934, 1.1145419, 1.7940282,
         2.1031263, 1.1228807, -0.3450048, -2.547587, -2.8297472, -2.007185, -2.7547684, -2.0771701, 0.6170643,
         1.4208611, 0.9245808, 2.1425502, 3.8779857, 4.019503, 4.1293855, 4.435047, 3.74018, 4.8445435, 4.9708014,
         2.3189113, 1.9061401, 3.8742228, 3.2548656, 0.26936293, -1.6731477, -0.0931381, 2.4896781, 4.242815, 6.2251496,
         6.395247, 6.016724, 5.9892364, 6.600346, 8.395384, 7.7119756, 6.708221, 6.8233504, 6.5641046, 5.0958204,
         4.1421533, 3.3716774, 1.2697282, -1.165326, -0.35312203, 0.92916334, 1.0826498, 0.07560734, -1.9348726,
         -2.65412, -0.349478, 2.8230217, 4.873701, 6.4724216, 5.4012694, 2.13027, 2.43062, 5.285504, 6.169984,
         3.7153013, 0.82691854, -0.30987796, -0.34244326, -1.1554538, -1.4222168, 0.54588175, 1.3161855, -0.7940379,
         -2.1402588, -0.08392254, 1.4972814, 1.8779668, 1.3023247, 1.3205773, 1.1990079, 0.51937973, 0.9367979,
         2.549942, 4.3594604, 4.57442, 3.8850708, 3.793997, 2.9707432, 0.29033718, -3.611599, -4.39027, -1.2024901,
         0.7403867, 1.4503417, 3.4867496, 5.6145887, 4.7352395, 1.3528466, -0.32886577, 0.22843973, 2.1324623,
         3.0730288, 3.5657518, 4.3257456, 2.9658787, -0.13660982, -2.7536447, -3.8739202, -4.474617, -4.749583,
         -5.9053316, -7.310759, -6.8130293, -5.437871, -3.653492, -2.2099955, -2.1828249, -3.148312, -4.111551,
         -4.2269087, -5.364239, -7.872718, -6.540237, -4.901399, -6.69651, -8.348945, -8.708213, -9.087016, -10.573982,
         -12.239656, -11.069622, -8.282403, -8.670962, -10.330088, -9.995873, -7.627503, -5.9327903, -3.814691,
         -3.2519112, -3.4073255, -3.5742745, -4.122308, -3.237818, -2.3053422, -3.1975925, -4.3276052, -4.6427283,
         -6.0580335, -7.0878124, -6.4435196, -4.574174, -3.2551842, -4.292901, -3.6430104, -1.4623718, -1.108711,
         -1.7863786, -0.59054226, 2.4185307, 5.0993395, 4.977562, 4.251591, 3.4795775, 2.3335829, 1.8501453, 1.5736737,
         -0.9169893, -4.092651, -4.7224903, -4.37381, -2.3417673, 0.0075389603, -0.93831825, -2.408272, -2.0944996,
         -1.2524635, -0.73950297, -0.36875114, 1.8890562, 3.5162818, 2.2592027, 2.3060875, 3.7223547, 4.0886073,
         2.4076583, 0.7113901, -0.80262446, -0.67166203, -1.0464004, -4.6367917, -7.841607, -8.374392, -5.9799514,
         -1.9996811, 1.1509198, 1.463701, 0.43553054, 0.6930718, 1.7380706, 1.6158984, 2.1249125, 3.2179005, 3.3339667,
         1.7667053, -0.043683946, -0.64766717, -0.5530388, -0.90928656, -2.1640522, -4.68672, -3.621813, -1.2681082,
         -1.9487425, -1.7395803, 1.4175254, 2.723816, 3.2582314, 5.044992, 4.7642717, 1.9170703, 1.0765666, 2.478871,
         2.795113, 3.5074031, 3.564786, 2.1338081, 1.0919349, 0.93268186, -0.39586568, -2.4092326, -2.6951702,
         -2.930578, -2.7966132, -1.056773, 0.36801797, 1.8092463, 1.545968, -2.1967523, -3.7437391, -0.9940314,
         1.3795766, 2.6769235, 0.480212, -1.9104145, -1.3184102, -0.93633413, -3.8791873, -6.771573, -6.5374556,
         -6.6877875, -8.089312, -8.195706, -6.6228065, -6.3733397, -6.642964, -4.5154195, -3.554839, -4.411544,
         -2.8698053, -0.5069682, 0.6493814, 0.15771398, 0.3683418, 1.0178262, 0.07302581, -1.7181361, -4.108292,
         -4.152974, -2.6665502, -0.8895337, -0.7690791, -2.630845, -4.370254, -4.1716723, -0.78009826, 1.6470513,
         2.2333012, 2.226649, 2.1797717, 2.494156, 4.8117166, 7.139054, 7.5054, 3.2489803, 0.95080346, 3.246154,
         3.9341533, -0.5381118, -3.9684489, -3.5460248, -2.0799599, -0.8909927, -0.7588386, 1.9380608, 6.002909,
         5.5813046, 2.4501796, 1.2198616, 1.145431, 3.3906693, 5.8408976, 4.709812, 4.3392224, 5.238724, 4.86223,
         4.1985497, 4.48486, 4.985898, 3.1907828, 0.34978196, 0.3521853, 0.99290156, 2.150963, 3.2568264, 3.9841938,
         4.0463095, 4.0846615, 5.6273036, 7.454742, 6.7856064, 5.114465, 4.1100388, 5.283401, 6.7065105, 6.776425,
         6.8412037, 6.7495584, 5.7330503, 4.2929063, 5.2769732, 4.44293, 1.7168101, 2.6596036, 4.5581684, 3.5994475,
         3.440836, 6.0018783, 7.358616, 6.9128685, 5.2892456, 5.6817102, 5.433912, 4.7559624, 4.6485705, 4.0575504,
         2.4033647, 0.589164, -0.79529274, -1.1207865, 1.0572019, 1.9493557, 0.3849046, -0.945485, -1.7680076,
         -0.7279609, -0.101556875, 0.16842797, 0.5977401, -0.1674067, -0.95106894, -2.2916687, -2.6140604]
print(len(array))

array_window = array[0:250]

# window data
window = signal.windows.blackman(len(array_window))
data = window * array_window
# fft
nfft = len(array_window)
fourier = np.fft.fft(data, nfft)
ps = np.abs(fourier) ** 2

# normalize
# ???


time_step = 1 / 1000
freqs = np.fft.fftfreq(nfft, time_step)

idx = np.argsort(freqs)

plt.title('Power spectrum (np.fft.fft)')
plt.plot(freqs[idx], ps[idx])
plt.show()

# alta var
# N = np.array(array_window).size
# u_fft = np.fft.rfft(array_window-np.nanmean(array_window))
#
# St = np.multiply(u_fft, np.conj(u_fft))
# St = np.divide(St, N)

array_window = detrend(array_window)
array_window = window * array_window
ffty = np.fft.rfft(array_window)
# power spectrum, after real2complex transfrom (factor )
scale = 2.0 / (len(array_window) * len(array_window))
power = scale * np.abs(ffty) ** 2
freq = np.fft.fftfreq(len(array_window), 1 / 1000)

freq2, power2 = scipy.signal.welch(array_window, 1000, window='boxcar', nperseg=len(array_window), scaling='spectrum',
                                   axis=-1)

for i in range(len(freq2)):
    print(i, freq2[i], power2[i], freq[i], power[i])
print(np.sum(power2))
print(np.sum(power))

plt.figure()
plt.plot(freq[0:126], power[0:126], label='np.fft.fft()')
plt.plot(freq2, power2, label='scipy.signal.welch()')
plt.legend()
plt.xlim(0, np.max(freq[0:126]))
plt.show()


#var 100

Fs=1000
N= len(array_window)
xdft = fft(array_window)
xdft = xdft[1:126]
psdx = (1/(N*Fs)) * abs(xdft)**2

psdx[2:125] = 2*psdx[2:125]
freq = np.fft.fftfreq(len(array_window), 1 / 1000)
plt.plot(freq[1:126],10*np.log10(psdx))
plt.title('Periodogram Using FFT')
plt.xlabel('Frequency (Hz)')
plt.ylabel('Power/Frequency (dB/Hz)')
plt.xlim(0, np.max(freq[0:126]))
plt.show()
# use fft
# dt = 0.001
# X_fourier = fft(array_window)
# frequencies = fftfreq(250, d=dt)
# # Only keep positive frequencies.
# keep = frequencies>=0
# X_fourier = X_fourier[keep]
# frequencies = frequencies[keep]
#
# ax1 = plt.subplot(111)
# ax1.plot(frequencies, np.abs(X_fourier)**2)
#
# plt.show()
#
# # signal.welch
window = signal.get_window('blackman', 250)
f, Pxx_spec = signal.welch(array_window, 1000,window='blackman', nperseg=250,noverlap=0, scaling='spectrum')
Pxx_den_dB = 10 * np.log10(Pxx_spec)  # Scale to dB
plt.figure()
plt.plot(f, Pxx_den_dB)
# plt.semilogy(f, np.sqrt(Pxx_spec))
plt.xlabel('frequency [Hz]')
plt.ylabel('Linear spectrum [V RMS]')
plt.title('Power spectrum (scipy.signal.welch)')
plt.show()
